# 18-3. Delegate / Action / Func / Event å¯¦æˆ°é¡Œåº«èˆ‡ç¯„ä¾‹å¤§å…¨

é€™ä»½æ–‡ä»¶æä¾›å¤§é‡çš„ç¨‹å¼ç¢¼ç¯„ä¾‹èˆ‡æ‡‰ç”¨å ´æ™¯ï¼Œå¹«åŠ©ä½ å¾ã€Œçœ‹æ‡‚ã€é€²éšåˆ°ã€Œæœƒç”¨ã€ã€‚æˆ‘å€‘å°‡é€éä¸åŒçš„æƒ…å¢ƒä¾†ç·´ç¿’é€™äº›å·¥å…·ã€‚

---

## 1. Delegate å¯¦æˆ°ï¼šæ‰“é€ éˆæ´»çš„éæ¿¾å™¨

**æƒ…å¢ƒ**ï¼šä½ æ˜¯ä¸€å€‹é›»å•†ç¶²ç«™çš„å¾Œç«¯å·¥ç¨‹å¸«ã€‚ä½ æœ‰ä¸€å€‹ç”¢å“æ¸…å–®ï¼Œè€é—†å¸¸å¸¸æå‡ºæ€ªç•°çš„ç¯©é¸éœ€æ±‚ï¼š
*   ã€Œæˆ‘è¦çœ‹æ‰€æœ‰å¤§æ–¼ 500 å…ƒçš„ç”¢å“ï¼ã€
*   ã€Œæˆ‘è¦çœ‹æ‰€æœ‰ç´…è‰²çš„ç”¢å“ï¼ã€
*   ã€Œæˆ‘è¦çœ‹åå­—è£¡é¢æœ‰ Pro çš„ç”¢å“ï¼ã€

å¦‚æœä½ æ¯æ¬¡éƒ½å¯«ä¸€å€‹æ–°æ–¹æ³• (`FilterByPrice`, `FilterByColor`...)ï¼Œä½ æœƒç´¯æ­»ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ Delegate æŠŠã€Œç¯©é¸é‚è¼¯ã€å¤–åŒ…

```csharp
using System;
using System.Collections.Generic;

namespace DelegateExample
{
    public class Product
    {
        public string Name { get; set; }
        public decimal Price { get; set; }
        public string Category { get; set; }
    }

    class Program
    {
        // 1. å®šç¾©ä¸€å€‹å§”æ´¾ï¼šåªè¦å›å‚³ boolï¼Œæ¥æ”¶ Productï¼Œå°±å¯ä»¥ç•¶ç¯©é¸å™¨
        public delegate bool ProductFilter(Product p);

        // 2. ä¸€å€‹é€šç”¨çš„ç¯©é¸æ–¹æ³•
        static void FilterProducts(List<Product> products, ProductFilter filter)
        {
            Console.WriteLine("--- é–‹å§‹ç¯©é¸ ---");
            foreach (var p in products)
            {
                // é€™è£¡æˆ‘å€‘ä¸çŸ¥é“å…·é«”é‚è¼¯æ˜¯ä»€éº¼ï¼Œå…¨çœ‹å‚³é€²ä¾†çš„ filter æ€éº¼å¯«
                if (filter(p))
                {
                    Console.WriteLine($"ç¬¦åˆ: {p.Name} (${p.Price})");
                }
            }
        }

        static void Main()
        {
            var inventory = new List<Product>
            {
                new Product { Name = "iPhone 15", Price = 30000, Category = "Electronics" },
                new Product { Name = "Banana", Price = 20, Category = "Food" },
                new Product { Name = "PS5 Pro", Price = 24000, Category = "Electronics" },
                new Product { Name = "Coffee", Price = 60, Category = "Food" }
            };

            // å¯¦æˆ° Aï¼šç¯©é¸åƒ¹æ ¼ > 10000 çš„ (ä½¿ç”¨ Lambda)
            FilterProducts(inventory, p => p.Price > 10000);

            // å¯¦æˆ° Bï¼šç¯©é¸é¡åˆ¥æ˜¯ Food çš„
            FilterProducts(inventory, p => p.Category == "Food");

            // å¯¦æˆ° Cï¼šè¤‡é›œé‚è¼¯ (åå­—æœ‰ Pro ä¸”åƒ¹æ ¼ > 20000)
            FilterProducts(inventory, p => p.Name.Contains("Pro") && p.Price > 20000);
        }
    }
}
```
> **å­¸ç¿’é»**ï¼š`ProductFilter` å§”æ´¾è®“æˆ‘å€‘æŠŠã€Œç¯©é¸é‚è¼¯ã€å¾ã€Œéæ­·é‚è¼¯ã€ä¸­åˆ†é›¢å‡ºä¾†ã€‚é€™å°±æ˜¯ **é–‹æ”¾å°é–‰åŸå‰‡ (OCP)** çš„é«”ç¾ã€‚

---

## 2. Action å¯¦æˆ°ï¼šå¤šé‡ä»»å‹™æŒ‰éˆ•

**æƒ…å¢ƒ**ï¼šä½ æ­£åœ¨å¯«ä¸€å€‹éŠæˆ²çš„ç™»å…¥æŒ‰éˆ•ã€‚ç•¶ç©å®¶é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æ™‚ï¼Œä½ éœ€è¦åŒæ™‚åšä¸‰ä»¶äº‹ï¼š
1.  æ’­æ”¾éŸ³æ•ˆã€‚
2.  è¨˜éŒ„ Log åˆ°å¾Œå°ã€‚
3.  åˆ‡æ›å ´æ™¯ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ Action å¤šæ’­ (Multicast)

```csharp
using System;

namespace ActionExample
{
    class Program
    {
        static void Main()
        {
            // å®šç¾©ä¸€å€‹ Actionï¼Œä»£è¡¨ã€Œé»æ“ŠæŒ‰éˆ•ã€é€™å€‹å‹•ä½œ
            Action onStartGameClick = null;

            // 1. æ›è¼‰éŸ³æ•ˆæ¨¡çµ„
            onStartGameClick += () => Console.WriteLine("ğŸµ æ’­æ”¾: Click_Sound.mp3");

            // 2. æ›è¼‰ç´€éŒ„æ¨¡çµ„
            onStartGameClick += () => Console.WriteLine("ğŸ“ Log: Player started game at " + DateTime.Now);

            // 3. æ›è¼‰å ´æ™¯åˆ‡æ›æ¨¡çµ„
            onStartGameClick += () => Console.WriteLine("ğŸš€ è¼‰å…¥: Level_1_Map");

            // ---- ç©å®¶é»æ“Šäº†æŒ‰éˆ• ----
            Console.WriteLine("ç©å®¶é»æ“Šäº† [Start]...");
            
            // ä¸€æ¬¡å‘¼å«ï¼ŒåŸ·è¡Œå…¨éƒ¨
            // æª¢æŸ¥æ˜¯å¦ç‚º null æ˜¯å¥½ç¿’æ…£ (é›–ç„¶é€™è£¡æˆ‘å€‘çŸ¥é“æœ‰æ›è¼‰)
            onStartGameClick?.Invoke(); 
        }
    }
}
```
> **å­¸ç¿’é»**ï¼š`Action` éå¸¸é©åˆé€™ç¨®ã€Œå°„å¾Œä¸ç† (Fire and Forget)ã€çš„å ´æ™¯ï¼Œç‰¹åˆ¥æ˜¯ç•¶ä½ éœ€è¦å°‡å¤šå€‹ç¨ç«‹çš„å­ç³»çµ±ä¸²æ¥åœ¨ä¸€èµ·æ™‚ã€‚

---

## 3. Func å¯¦æˆ°ï¼šè³‡æ–™è®Šå½¢å·¥å» 

**æƒ…å¢ƒ**ï¼šä½ éœ€è¦è™•ç†ä¸€å †å­—ä¸²è³‡æ–™ã€‚è™•ç†çš„æµç¨‹å¯èƒ½æœƒè®Šï¼š
*   æœ‰æ™‚å€™è¦ã€Œå»ç©ºç™½ -> è½‰å¤§å¯«ã€ã€‚
*   æœ‰æ™‚å€™è¦ã€ŒåŠ å‰ç¶´ -> è½‰å°å¯« -> æ“·å–å‰5ç¢¼ã€ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šFunc éˆå¼è™•ç†

```csharp
using System;

namespace FuncExample
{
    class Program
    {
        // é€™æ˜¯æˆ‘å€‘çš„è™•ç†å¼•æ“
        static void ProcessString(string input, Func<string, string> processor)
        {
            string result = processor(input);
            Console.WriteLine($"åŸå§‹: '{input}' -> çµæœ: '{result}'");
        }

        static void Main()
        {
            string rawData = "  Hello World  ";

            // ç­–ç•¥ 1: ç°¡å–®æ¸…ç†
            // Trim() å»ç©ºç™½, ToUpper() è½‰å¤§å¯«
            ProcessString(rawData, s => s.Trim().ToUpper());
            // è¼¸å‡º: '  Hello World  ' -> 'HELLO WORLD'

            // ç­–ç•¥ 2: è®Šæˆ HTML æ¨™ç±¤
            ProcessString(rawData, s => $"<h1>{s.Trim()}</h1>");
            // è¼¸å‡º: '  Hello World  ' -> '<h1>Hello World</h1>'

            // ç­–ç•¥ 3: æ“·å–éƒ¨åˆ†å…§å®¹
            // å¦‚æœå­—ä¸²é•·åº¦ > 5 å°±åˆ‡å­—ï¼Œå¦å‰‡åŸæ¨£å›å‚³ (ä¸‰å…ƒé‹ç®—å­)
            ProcessString("Code", s => s.Length > 5 ? s.Substring(0, 5) : s);
            ProcessString("SuperLongString", s => s.Length > 5 ? s.Substring(0, 5) + "..." : s);
        }
    }
}
```
> **å­¸ç¿’é»**ï¼š`Func<T, TResult>` æ˜¯ LINQ çš„åŸºçŸ³ã€‚ä½ åœ¨ç”¨ `.Select()`, `.Where()` æ™‚ï¼Œå…¶å¯¦å°±æ˜¯åœ¨å¯« `Func`ã€‚

---

## 4. Event å¯¦æˆ°ï¼šç«ç½è­¦å ±ç³»çµ±

**æƒ…å¢ƒ**ï¼šå¤§æ¨“è£¡æœ‰ä¸€å€‹ç«ç½åµæ¸¬å™¨ã€‚ç•¶åµæ¸¬åˆ°ç…™éœ§æ™‚ï¼Œå®ƒéœ€è¦é€šçŸ¥ï¼š
1.  ç‘æ°´ç³»çµ± (é–‹å§‹ç‘æ°´)ã€‚
2.  å»£æ’­ç³»çµ± (ç™¼å‡ºè­¦å ±è²)ã€‚
3.  ä¿å…¨ç³»çµ± (è‡ªå‹•è§£é–é€ƒç”Ÿé–€)ã€‚

é€™æ˜¯ä¸€å€‹æ¨™æº–çš„ **è§€å¯Ÿè€…æ¨¡å¼ (Observer Pattern)**ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šEvent äº‹ä»¶é©…å‹•

```csharp
using System;

namespace EventExample
{
    // 1. å®šç¾©äº‹ä»¶åƒæ•¸ (åŒ…å«ç«ç½ä½ç½®èˆ‡æº«åº¦)
    public class FireEventArgs : EventArgs
    {
        public string Location { get; set; }
        public double Temperature { get; set; }
    }

    // 2. ç™¼å¸ƒè€…ï¼šç«ç½åµæ¸¬å™¨
    public class FireDetector
    {
        // å®£å‘Šäº‹ä»¶
        public event EventHandler<FireEventArgs> FireDetected;

        public void DetectSmoke(string location, double temp)
        {
            if (temp > 50) // æº«åº¦éé«˜
            {
                Console.WriteLine($"ğŸ”¥ åµæ¸¬å™¨: åœ¨ {location} ç™¼ç¾ç•°å¸¸é«˜æº« ({temp}Â°C)ï¼");
                
                // è§¸ç™¼äº‹ä»¶
                OnFireDetected(new FireEventArgs { Location = location, Temperature = temp });
            }
        }

        protected virtual void OnFireDetected(FireEventArgs e)
        {
            FireDetected?.Invoke(this, e);
        }
    }

    // 3. è¨‚é–±è€…å€‘
    public class Sprinkler // ç‘æ°´å™¨
    {
        public void OnFire(object sender, FireEventArgs e)
        {
            Console.WriteLine($"ğŸ’¦ ç‘æ°´å™¨: é‡å° {e.Location} å•Ÿå‹•å™´æ°´ï¼");
        }
    }

    public class SecuritySystem // ä¿å…¨
    {
        public void OnFire(object sender, FireEventArgs e)
        {
            Console.WriteLine($"ğŸšª ä¿å…¨: å·²è§£é– {e.Location} é™„è¿‘çš„é€ƒç”Ÿé–€ã€‚");
        }
    }

    class Program
    {
        static void Main()
        {
            var detector = new FireDetector();
            var sprinkler = new Sprinkler();
            var security = new SecuritySystem();

            // è¨‚é–±ï¼šæŠŠå¤§å®¶ä¸²èµ·ä¾†
            detector.FireDetected += sprinkler.OnFire;
            detector.FireDetected += security.OnFire;

            // æ¨¡æ“¬æƒ…æ³ 1: æº«åº¦æ­£å¸¸
            detector.DetectSmoke("å»šæˆ¿", 35); // æ²’äº‹ï¼Œä¸æœƒè§¸ç™¼

            Console.WriteLine("...");

            // æ¨¡æ“¬æƒ…æ³ 2: å¤±ç«äº†
            detector.DetectSmoke("ä¼ºæœå™¨æ©Ÿæˆ¿", 85);
            // è§¸ç™¼ï¼ç‘æ°´å™¨å’Œä¿å…¨éƒ½æœƒæ”¶åˆ°é€šçŸ¥
        }
    }
}
```

---

## 5. è‡ªæˆ‘ç·´ç¿’é¡Œ (é™„è§£ç­”)

è©¦è‘—å…ˆä¸çœ‹ç­”æ¡ˆï¼Œè‡ªå·±å¯«å¯«çœ‹ï¼

### é¡Œç›® 1: è¨ˆç®—æ©Ÿå·¥å»  (Func)
è«‹å¯«ä¸€å€‹ `Calculate` æ–¹æ³•ï¼Œæ¥æ”¶å…©å€‹ `int` å’Œä¸€å€‹é‹ç®—é‚è¼¯ `Func<int, int, int>`ã€‚
ç„¶å¾Œç”¨å®ƒåˆ†åˆ¥è¨ˆç®—ï¼š
1.  ç›¸åŠ 
2.  ç›¸ä¹˜
3.  ç¬¬ä¸€å€‹æ•¸çš„ç¬¬äºŒå€‹æ•¸æ¬¡æ–¹ (ä¾‹å¦‚ 2 çš„ 3 æ¬¡æ–¹ = 8)

<details>
<summary>é»æ“ŠæŸ¥çœ‹åƒè€ƒè§£ç­”</summary>

```csharp
using System;

class Program
{
    static void Calculate(int a, int b, Func<int, int, int> operation)
    {
        int result = operation(a, b);
        Console.WriteLine($"Result: {result}");
    }

    static void Main()
    {
        Calculate(10, 5, (x, y) => x + y); // åŠ æ³•: 15
        Calculate(10, 5, (x, y) => x * y); // ä¹˜æ³•: 50
        Calculate(2, 3, (x, y) => (int)Math.Pow(x, y)); // æ¬¡æ–¹: 8
    }
}
```
</details>

### é¡Œç›® 2: ä¸‹è¼‰å®Œæˆé€šçŸ¥ (Event)
è¨­è¨ˆä¸€å€‹ `Downloader` é¡åˆ¥ï¼Œæœ‰ä¸€å€‹ `Download(string url)` æ–¹æ³•ã€‚
æ¨¡æ“¬ä¸‹è¼‰éç¨‹ (å¯ä»¥ç”¨ `Thread.Sleep`)ï¼Œä¸‹è¼‰å®Œæˆå¾Œè§¸ç™¼ `DownloadCompleted` äº‹ä»¶ï¼Œä¸¦å‚³å›ä¸‹è¼‰çš„æª”æ¡ˆå¤§å° (int)ã€‚

<details>
<summary>é»æ“ŠæŸ¥çœ‹åƒè€ƒè§£ç­”</summary>

```csharp
using System;
using System.Threading;

// äº‹ä»¶åƒæ•¸
public class DownloadArgs : EventArgs
{
    public string Url { get; set; }
    public int SizeMB { get; set; }
}

public class Downloader
{
    public event EventHandler<DownloadArgs> DownloadCompleted;

    public void Download(string url)
    {
        Console.WriteLine($"é–‹å§‹ä¸‹è¼‰: {url} ...");
        Thread.Sleep(1000); // å‡è£åœ¨ä¸‹è¼‰
        
        // è§¸ç™¼äº‹ä»¶
        DownloadCompleted?.Invoke(this, new DownloadArgs { Url = url, SizeMB = 100 });
    }
}

class Program
{
    static void Main()
    {
        Downloader dl = new Downloader();
        
        // è¨‚é–±
        dl.DownloadCompleted += (sender, e) => 
        {
            Console.WriteLine($"âœ… ä¸‹è¼‰å®Œæˆï¼ç¶²å€: {e.Url}, å¤§å°: {e.SizeMB}MB");
        };

        dl.Download("https://google.com/file.zip");
    }
}
```
</details>
