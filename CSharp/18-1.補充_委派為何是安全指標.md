# è£œå……è§£æï¼šç‚ºä½•èªª Delegate æ˜¯ã€Œå‹åˆ¥å®‰å…¨çš„æŒ‡æ¨™ã€ï¼Ÿ

é€™å¥è©±åŒ…å«äº†å…©å€‹é›»è…¦ç§‘å­¸çš„é‡è¦æ¦‚å¿µï¼š**ã€ŒæŒ‡æ¨™ (Pointer)ã€** èˆ‡ **ã€Œå‹åˆ¥å®‰å…¨ (Type-Safe)ã€**ã€‚è®“æˆ‘å€‘é€éåœ–è§£èˆ‡å°æ¯”ä¾†å¾¹åº•ç†è§£ã€‚

---

## 1. ä»€éº¼æ˜¯ã€ŒæŒ‡æ¨™ (Pointer)ã€ï¼Ÿ

åœ¨ C æˆ– C++ ç­‰è¼ƒåº•å±¤çš„èªè¨€ä¸­ï¼Œå‡½å¼ (Function) å…¶å¯¦å°±æ˜¯**è¨˜æ†¶é«”ä¸­çš„ä¸€æ®µç¨‹å¼ç¢¼**ã€‚é€™æ®µç¨‹å¼ç¢¼æœ‰ä¸€å€‹èµ·å§‹çš„è¨˜æ†¶é«”ä½å€ï¼ˆä¾‹å¦‚ `0x7FFF00A1`ï¼‰ã€‚

ç•¶æˆ‘å€‘èªªã€ŒæŒ‡æ¨™ã€æ™‚ï¼Œæ„æ€å°±æ˜¯**ã€Œæ‹¿è‘—é€™å€‹è¨˜æ†¶é«”ä½å€ã€**ã€‚

### C/C++ çš„å‡½å¼æŒ‡æ¨™ (Function Pointer) - å±éšªçš„è‡ªç”±
åœ¨ C èªè¨€ä¸­ï¼Œä½ å¯ä»¥æ‹¿åˆ°ä»»ä½•å‡½å¼çš„ä½å€ä¸¦åŸ·è¡Œå®ƒã€‚ä½†é€™å°±åƒ**æ‹¿è‘—ä¸€å¼µåªå¯«äº†åœ°å€çš„å°ç´™æ¢**ï¼š
1.  ä½ åˆ°äº†åœ°å€ï¼Œç™¼ç¾é‚£è£¡å¯èƒ½å·²ç¶“ä¸æ˜¯åŸæœ¬çš„åº—å®¶äº†ï¼ˆè¨˜æ†¶é«”è¢«å›æ”¶æˆ–è¦†è“‹ï¼‰ã€‚
2.  ä½ æƒ³é€²å»è²·æ¼¢å ¡ï¼Œä½†é‚£å…¶å¯¦æ˜¯ä¸€é–“äº”é‡‘è¡Œï¼ˆåƒæ•¸å‹åˆ¥ä¸å°ï¼Œä¾‹å¦‚æ–¹æ³•éœ€è¦ `int` ä½ å»å‚³äº† `string`ï¼‰ã€‚
3.  **çµæœ**ï¼šç¨‹å¼ç›´æ¥å´©æ½° (Crash) æˆ–ç”¢ç”Ÿä¸å¯é æœŸçš„äº‚ç¢¼ã€‚

```mermaid
graph LR
    Caller[å‘¼å«è€…] -->|ç›´æ¥è·³è½‰ä½å€ 0x12AB| Memory[è¨˜æ†¶é«”å€å¡Š]
    
    subgraph å±éšªå€åŸŸ
    Memory -->|åƒæ•¸éŒ¯èª¤?| Crash[ğŸ’¥ åŸ·è¡ŒæœŸå´©æ½°]
    Memory -->|ä½å€ç„¡æ•ˆ?| Crash
    end
    
    style Crash fill:#ffcccc,stroke:#ff0000
    style Memory fill:#e1e1e1
```

---

## 2. ä»€éº¼æ˜¯ã€ŒDelegate (å§”æ´¾)ã€ï¼Ÿ

C# çš„ Delegate ä¸åƒ…åƒ…æ˜¯ä¸€å€‹ä½å€ï¼Œå®ƒæ˜¯ä¸€å€‹ **ç‰©ä»¶ (Object)**ã€‚å®ƒå°±åƒæ˜¯ä¸€å¼µ**ã€Œå®˜æ–¹æ­£å¼é‚€è«‹å‡½ã€**ã€‚

é€™å¼µé‚€è«‹å‡½ï¼ˆDelegate ç‰©ä»¶ï¼‰è£¡é¢åŒ…å«å…©æ¨£é—œéµè³‡è¨Šï¼š
1.  **æ–¹æ³•æŒ‡æ¨™ (`_methodPtr`)**ï¼šè¦å»å“ªè£¡åŸ·è¡Œä»£ç¢¼ï¼ˆè¨˜æ†¶é«”ä½å€ï¼‰ã€‚
2.  **ç›®æ¨™ç‰©ä»¶ (`_target`)**ï¼šé€™æ®µä»£ç¢¼å±¬æ–¼å“ªå€‹ç‰©ä»¶å¯¦é«”ï¼ˆå¦‚æœæ˜¯ static æ–¹æ³•å‰‡ç‚º nullï¼‰ã€‚

### C# çš„ Delegate - å®‰å…¨çš„å°è£
ç•¶ä½ å»ºç«‹ Delegate æ™‚ï¼ŒC# ç·¨è­¯å™¨æœƒåš´æ ¼æª¢æŸ¥é€™å¼µã€Œé‚€è«‹å‡½ã€çš„è¦æ ¼ï¼š
*   **æª¢æŸ¥**ï¼šä½ è¦å‚³çš„åƒæ•¸æ˜¯ `int` å—ï¼Ÿ
*   **æª¢æŸ¥**ï¼šå›å‚³å€¼æ˜¯ `string` å—ï¼Ÿ
*   **çµæœ**ï¼šå¦‚æœè¦æ ¼ä¸ç¬¦ï¼Œ**ç¨‹å¼é€£ç·¨è­¯éƒ½ä¸æœƒé€šé**ï¼ˆç´…åº•æ³¢æµªç·šï¼‰ï¼Œæ ¹æœ¬ä¸æœƒè®“ä½ æœ‰æ©Ÿæœƒåœ¨åŸ·è¡Œæ™‚å´©æ½°ã€‚

```mermaid
graph LR
    Caller[å‘¼å«è€…] -->|"Invoke()"| DelegateObj[Delegate ç‰©ä»¶]
    
    subgraph Delegate å…§éƒ¨çµæ§‹
    DelegateObj --åŒ…å«--> MethodPtr[å…§éƒ¨æ–¹æ³•æŒ‡æ¨™ _methodPtr]
    DelegateObj --åŒ…å«--> Target[ç›®æ¨™ç‰©ä»¶ _target]
    end
    
    Target -->|Context| MethodCode[å¯¦éš›æ–¹æ³•é‚è¼¯]
    MethodPtr -->|æŒ‡å‘| MethodCode
    
    style DelegateObj fill:#d4f1f4,stroke:#0077b6,stroke-width:2px
    style MethodCode fill:#d9fdd3,stroke:#2d6a4f
```

---

## 3. è¦–è¦ºåŒ–æ¯”è¼ƒï¼šè£¸æŒ‡æ¨™ vs å§”æ´¾

è®“æˆ‘å€‘ç”¨ Mermaid æµç¨‹åœ–ä¾†å°æ¯”å…©è€…çš„é‹ä½œæµç¨‹å·®ç•°ã€‚

### 3.1 C/C++ è£¸æŒ‡æ¨™ (Raw Pointer)
å®Œå…¨ä¿¡ä»»ç¨‹å¼è¨­è¨ˆå¸«ï¼Œç·¨è­¯å™¨ä¸è² è²¬ä»»ã€‚

```mermaid
sequenceDiagram
    participant P as Programmer
    participant CP as C++ Compiler
    participant M as Memory(Runtime)

    P->>CP: æˆ‘è¦æŠŠ 0x1234 ç•¶ä½œå‡½å¼å‘¼å«ï¼Œåƒæ•¸çµ¦ "Hello"
    CP->>P: å¥½å–”ï¼Œä½ æ˜¯è€å¤§ (ç·¨è­¯é€šé)
    
    Note over M: åŸ·è¡Œæ™‚...
    P->>M: è·³è½‰åˆ° 0x1234 åŸ·è¡Œ
    M-->>P: 0x1234 å…¶å¯¦éœ€è¦ int åƒæ•¸... è¨˜æ†¶é«”éŒ¯äº‚... ğŸ’¥ å´©æ½°
```

### 3.2 C# å§”æ´¾ (Type-Safe Delegate)
ç·¨è­¯å™¨å¦‚åŒåš´æ ¼çš„è­¦è¡›ï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„ã€Œå‹åˆ¥å®‰å…¨ã€ã€‚

```mermaid
sequenceDiagram
    participant P as Programmer
    participant CS as Cäº• Compiler
    participant M as Memory(Runtime)

    Note right of CS: å®šç¾© delegate void MyDel(int x)

    P->>CS: æˆ‘æƒ³æŠŠæ–¹æ³• Method(string s) æŒ‡æ´¾çµ¦ MyDel
    CS--xP: âŒ éŒ¯èª¤ï¼å‹åˆ¥ä¸ç¬¦ï¼(int vs string)
    Note over P: ç¨‹å¼ç„¡æ³•åŸ·è¡Œï¼Œå¿…é ˆå…ˆä¿®æ­£ç¨‹å¼ç¢¼

    P->>CS: ä¿®æ­£ï¼šæŒ‡æ´¾ Method(int x) çµ¦ MyDel
    CS->>P: âœ… æª¢æŸ¥é€šé (ç·¨è­¯æˆåŠŸ)

    Note over M: åŸ·è¡Œæ™‚...
    P->>M: é€é Delegate å‘¼å«
    M->>M: åƒæ•¸å‹åˆ¥çµ•å°æ­£ç¢ºï¼Œå®‰å…¨åŸ·è¡Œ
```

---

## 4. ç¨‹å¼ç¢¼æ¼”ç¤º

### æ¨¡æ“¬éŒ¯èª¤æƒ…å¢ƒ

```csharp
// å®šç¾©ä¸€å€‹éœ€è¦ int çš„å§”æ´¾
public delegate void IntDelegate(int x);

public class Demo
{
    public void StringMethod(string s) 
    {
        Console.WriteLine(s);
    }

    public void Run()
    {
        // C# çš„å‹åˆ¥å®‰å…¨æ©Ÿåˆ¶ï¼š
        // é€™ä¸€è¡Œæœƒç›´æ¥é¡¯ç¤ºç´…è‰²éŒ¯èª¤ï¼Œç„¡æ³•ç·¨è­¯ã€‚
        // å› ç‚º "IntDelegate" è¦å®šè¦åƒ intï¼Œä½†ä½ å»çµ¦äº†åƒ string çš„æ–¹æ³•ã€‚
        
        // IntDelegate myDel = new IntDelegate(StringMethod); // <--- ç·¨è­¯éŒ¯èª¤ CS0123
        
        // å¦‚æœæ˜¯åœ¨ C èªè¨€ä½¿ç”¨ void* æŒ‡æ¨™ï¼Œé€™è¡Œå¯èƒ½å°±éäº†ï¼Œç„¶å¾Œåœ¨åŸ·è¡Œæ™‚çˆ†ç‚¸ã€‚
    }
}
```

## 5. ç¸½çµ

| ç‰¹æ€§ | C/C++ å‡½å¼æŒ‡æ¨™ | C# Delegate |
| :--- | :--- | :--- |
| **æœ¬è³ª** | å–®ç´”çš„è¨˜æ†¶é«”ä½å€ (Address) | åŒ…å«ä½å€èˆ‡ç›®æ¨™çš„å®Œæ•´ç‰©ä»¶ (Object) |
| **åƒæ•¸æª¢æŸ¥** | åŸ·è¡ŒæœŸå¯èƒ½ä¸æª¢æŸ¥ (ä¾è³´è½‰å‹) | **ç·¨è­¯æœŸ**åš´æ ¼æª¢æŸ¥ (Compile-time Check) |
| **å®‰å…¨æ€§** | ä¸å®‰å…¨ (Unsafe) | **å‹åˆ¥å®‰å…¨ (Type-Safe)** |
| **å¤šæ’­èƒ½åŠ›** | ç„¡ (åªèƒ½æŒ‡ä¸€å€‹) | å…§å»ºæ”¯æ´ (Multicast, +=) |

æ‰€ä»¥ï¼Œç•¶æˆ‘å€‘èªª **ã€ŒDelegate æ˜¯å‹åˆ¥å®‰å…¨çš„æŒ‡æ¨™ã€**ï¼Œæ„æ€æ˜¯å®ƒä¿ç•™äº†æŒ‡æ¨™ã€Œå‹•æ…‹æŒ‡å‘ä¸åŒæ–¹æ³•ã€çš„éˆæ´»åº¦ï¼Œä½†å»é™¤äº†å‚³çµ±æŒ‡æ¨™ã€Œå®¹æ˜“æŒ‡éŒ¯ã€åƒæ•¸äº‚å‚³ã€çš„å±éšªæ€§ã€‚
