# 02語法

## 過濾（Filtering）

### `Where`: 基於條件過濾序列  
  
基本用法: 根據條件過濾序列。

```C#
var numbers = new List<int> { 1, 6, 2, 9, 5 };
var filteredNumbers = numbers.Where(n => n > 5);
```

多載用法: 使用元素的索引作為過濾條件。

```C#
var filteredWithIndex = numbers.Where((num, index) => index % 2 == 0);
```

## 排序（Ordering）

### `OrderBy`: 按指定鍵值升序排序  

基本用法:

```C#
var students = new List<Student> { /* ... */ };
var sortedStudents = students.OrderBy(s => s.Age);
```

---------

### `OrderByDescending`: 按指定鍵值降序排序

基本用法:

```C#
var descendingSortedStudents = students.OrderByDescending(s => s.Age);
```

---------

### `ThenBy`: 在前一個排序條件之後進行二級排序（升序）

基本用法:

```C#
var sortedByName = students.OrderBy(s => s.LastName).ThenBy(s => s.FirstName);
```

---------

### `ThenByDescending`: 在前一個排序條件之後進行二級排序（降序）

基本用法:

```C#
var sortedByNameDesc = students.OrderBy(s => s.LastName).ThenByDescending(s => s.FirstName);
```

---------

- `Reverse`: 反轉序列中元素的順序。

基本用法:

```C#
var numbers = new List<int> { 1, 2, 3, 4, 5 };
numbers.Reverse();
```

## 投影（Projection）

### `Select`: 投影每個元素到一個新形式

#### 1. 基本投影

轉換集合中的元素到一個新的形式。

```csharp
var numbers = new List<int> { 1, 2, 3, 4, 5 };
var squares = numbers.Select(x => x * x); // 將每個數字映射到其平方
```

#### 2. 投影到新類型

創建一個新的物件類型。

```csharp
var students = new List<Student> { /* ... */ };
var studentDTOs = students.Select(s => new StudentDTO { Name = s.Name, Age = s.Age });
```

#### 3. 使用索引

在Lambda中使用元素的索引。

```csharp
var words = new List<string> { "apple", "banana", "cherry" };
var indexedWords = words.Select((word, index) => new { Index = index, Word = word });
```

#### 4. 條件性投影

根據條件改變投影的結果。

```csharp
var numbers = new List<int> { 1, 2, 3, 4, 5 };
var labels = numbers.Select(n => n % 2 == 0 ? "Even" : "Odd");
```

#### 5. 複雜類型的投影

從複雜對象中選擇多個屬性。

```csharp
var orders = new List<Order> { /* ... */ };
var orderInfos = orders.Select(o => new { o.OrderId, o.Customer.Name, o.TotalAmount });
```

#### 6. 鏈接投影

將 `Select` 與其他 LINQ 方法結合使用。

```csharp
var students = new List<Student> { /* ... */ };
var topStudentNames = students.Where(s => s.Grade > 90).Select(s => s.Name);
```

---------

### `SelectMany`: 將序列的序列平坦化為一個序列，特別有用於處理嵌套集合或多級結構的數據

#### 1. 基本使用 - 扁平化嵌套集合

當每個元素本身是一個集合時，將這些集合合併成一個單一的序列。

```csharp
var listOfLists = new List<List<int>>
{
    new List<int> { 1, 2, 3 },
    new List<int> { 4, 5, 6 },
    new List<int> { 7, 8, 9 }
};

var flattened = listOfLists.SelectMany(x => x);
// 結果: 1, 2, 3, 4, 5, 6, 7, 8, 9
```

#### 2. 投影並扁平化

對集合的每個元素進行處理，並將結果扁平化。

```csharp
public class Course
{
    public string CourseName { get; set; }
}

public class Student
{
    public string Name { get; set; }
    public List<Course> Courses { get; set; }
}
var students = new List<Student>
{
    new Student {
        Name = "Alice",
        Courses = new List<Course> {
            new Course { CourseName = "Math" },
            new Course { CourseName = "English" }
        }
    },
    new Student {
        Name = "Bob",
        Courses = new List<Course> {
            new Course { CourseName = "Science" },
            new Course { CourseName = "History" }
        }
    }
};
var allCourses = students.SelectMany(s => s.Courses).Select(c => c.CourseName).ToList();

foreach (var course in allCourses)
{
    Console.WriteLine(course);
} 
// 扁平化學生的課程列表，得到所有學生的所有課程。
```

### 3. 結合多個集合

使用 `SelectMany` 結合多個集合的元素。

```csharp
var chars = new List<char> { 'A', 'B', 'C' };
var numbers = new List<int> { 1, 2, 3 };

var combinations = chars.SelectMany(c => numbers, (c, n) => $"{c}{n}");
// 結果: "A1", "A2", "A3", "B1", "B2", "B3", "C1", "C2", "C3"
```

#### 4. 使用索引

在委托中使用元素的索引。

```csharp
var listOfLists = new List<List<int>>
{
    new List<int> { 1, 2 },
    new List<int> { 3, 4 }
};

var indexedFlattened = listOfLists.SelectMany((subList, index) => subList.Select(item => new { index, item }));
// 結果: { index = 0, item = 1 }, { index = 0, item = 2 }, { index = 1, item = 3 }, { index = 1, item = 4 }
```

#### 5. 扁平化複雜數據結構

用於更複雜的數據結構，如多層嵌套集合。

定義 `School`、`Class` 和 `Student` 類：

```csharp
public class School
{
    public string Name { get; set; }
    public List<Class> Classes { get; set; }
}

public class Class
{
    public string ClassName { get; set; }
    public List<Student> Students { get; set; }
}

public class Student
{
    public string Name { get; set; }
}
```

然後，我們創建一個包含學校、班級和學生的列表：

```csharp
var schools = new List<School>
{
    new School
    {
        Name = "School A",
        Classes = new List<Class>
        {
            new Class
            {
                ClassName = "Class 1A",
                Students = new List<Student>
                {
                    new Student { Name = "Alice" },
                    new Student { Name = "Bob" }
                }
            },
            new Class
            {
                ClassName = "Class 1B",
                Students = new List<Student>
                {
                    new Student { Name = "Charlie" },
                    new Student { Name = "David" }
                }
            }
        }
    },
    new School
    {
        Name = "School B",
        Classes = new List<Class>
        {
            new Class
            {
                ClassName = "Class 2A",
                Students = new List<Student>
                {
                    new Student { Name = "Emma" },
                    new Student { Name = "Frank" }
                }
            }
        }
    }
};
```

最後，使用 `SelectMany` 提取所有學校的所有班級的所有學生：

```csharp
var allStudents = schools.SelectMany(school => school.Classes.SelectMany(class => class.Students)).ToList();

foreach (var student in allStudents)
{
    Console.WriteLine(student.Name);
}
```

## 分組（Grouping）

- `GroupBy`: 根據鍵值將序列元素分組。

## 聚合（Aggregation）

- `Count`: 計算序列中的元素數量。
- `Sum`: 計算序列中數字的總和。
- `Average`: 計算序列中數字的平均值。
- `Min`: 找出序列中的最小值。
- `Max`: 找出序列中的最大值。
- `Aggregate`: 通過累加器函數對序列的元素進行累積。

## 集合操作（Set）

- `Distinct`: 移除序列中的重複元素。
- `Union`: 聯合兩個序列。
- `Intersect`: 求兩個序列的交集。
- `Except`: 從一個序列中排除另一個序列中的元素。

## 元素操作（Element）

- `First`: 返回序列中的第一個元素。
- `FirstOrDefault`: 返回序列中的第一個元素，如果序列為空，則返回預設值。
- `Last`: 返回序列中的最後一個元素。
- `LastOrDefault`: 返回序列中的最後一個元素，如果序列為空，則返回預設值。
- `Single`: 返回序列中的唯一元素，如果序列中沒有元素或者有多個元素，則拋出異常。
- `SingleOrDefault`: 返回序列中的唯一元素，如果序列為空，則返回預設值；如果序列中有多個元素，則拋出異常。
- `ElementAt`: 返回序列中指定索引處的元素。
- `ElementAtOrDefault`: 返回序列中指定索引處的元素，如果索引超出範圍，則返回預設值。

## 分割（Partitioning）

- `Take`: 從序列的開始返回指定數量的元素。
- `Skip`: 跳過序列的開始部分，返回餘下的元素。
- `TakeWhile`: 返回序列中符合條件的連續元素。
- `SkipWhile`: 跳過序列中符合條件的連續元素，然後返回餘下的元素。

## 轉換（Conversion）

- `ToArray`: 將序列轉換為數組。
- `ToList`: 將序列轉換為列表。
- `ToDictionary`: 將序列元素轉換為字典。
- `OfType`: 根據指定的類型過濾序列的元素。

## 量化（Quantifiers）

- `Any`: 檢查序列中是否有任何元素滿足條件。
- `All`: 檢查序列中的所有元素是否都滿足條件。

## 生成操作（Generation）

- `Empty`: 返回空的序列。
- `Range`: 生成一個包含指定範圍內連續整數的序列。
- `Repeat`: 生成一個包含重複值的序列。

## 異常處理（Exception Handling）

- `Catch`: 當源序列引發異常時提供替代序列。
- `Finally`: 無論序列是否引發異常，都要執行某些最終操作。

## 延遲執行（Deferred Execution）

- `AsEnumerable`: 將任何類型的 `IQueryable` 轉換為 `IEnumerable`，以進行本地查詢操作。
- `AsQueryable`: 將任何類型的 `IEnumerable` 轉換為 `IQueryable`。

## 連接（Joining）

- `Join`: 通過匹配鍵值將兩個序列的元素組合在一起。
- `GroupJoin`: 基於匹配鍵值，將兩個序列的元素與它們的匹配組合在一起。

## 預設值（Default Values）

- `DefaultIfEmpty`: 如果序列為空，則返回一個包含單個預設值的序列。

## 組合（Concatenation）

- `Concat`: 連接兩個序列。

## 分隔（Paging）

- `SkipLast`: 跳過序列末尾的指定數量的元素。
- `TakeLast`: 從序列末尾取出指定數量的元素。

## 異步操作（Asynchronous）

- `ToListAsync`, `ToArrayAsync`, `ToDictionaryAsync` 等：用於異步操作的方法，主要用於 Entity Framework Core。

## 比較（Comparisons）

- `SequenceEqual`: 確定兩個序列是否按相同的順序具有相同的元素。

## 鑄造（Casting）

- `Cast`: 將 `IEnumerable` 的元素轉換為指定的類型。

## 分組結果（Grouping Results）

- `ToLookup`: 根據鍵值將序列元素分組並創建一個 `Lookup`（類似於一個一對多的字典）。

## 字串操作（String-specific）

- `Contains`: 檢查序列中是否包含特定元素。
- `StartsWith`, `EndsWith`: 這些方法通常用於字符串序列，檢查元素是否以特定的子串開始或結束。

## 反射操作

- `AsParallel`, `AsOrdered`, `AsUnordered`: 這些方法用於 PLINQ（Parallel LINQ），支持對數據的並行處理。

## 自訂操作

- `Let`: 在查詢中引入新的識別符，以存儲中間結果或進行複雜的子查詢。
